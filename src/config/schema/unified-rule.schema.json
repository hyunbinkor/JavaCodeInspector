{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "unified-rule.schema.json",
    "title": "UnifiedRule",
    "description": "v4.0 Unified Rule Schema - checkType 재구성 (pure_regex, llm_with_regex, llm_contextual, llm_with_ast)",
    "type": "object",
    
    "required": [
      "ruleId",
      "title", 
      "description",
      "category",
      "severity",
      "checkType"
    ],
    
    "properties": {
      
      "ruleId": {
        "type": "string",
        "description": "규칙 고유 식별자",
        "pattern": "^[A-Z]{2,5}-[0-9]{3}$",
        "examples": ["AST-001", "CTX-001", "SEC-001", "ARCH-001", "REG-001"]
      },
      
      "title": {
        "type": "string",
        "description": "규칙 제목 (한글 또는 영문, 100자 이내)",
        "maxLength": 100,
        "examples": ["빈 catch 블록 금지", "Controller에서 비즈니스 로직 분리"]
      },
      
      "description": {
        "type": "string",
        "description": "규칙 상세 설명",
        "maxLength": 500,
        "examples": ["catch 블록에서 예외를 무시하지 말고 최소한 로깅을 수행해야 합니다"]
      },
      
      "category": {
        "type": "string",
        "description": "규칙 카테고리",
        "enum": [
          "naming_convention",
          "code_style",
          "exception_handling",
          "resource_management",
          "security",
          "architecture",
          "performance",
          "documentation",
          "framework_specific",
          "general"
        ]
      },
      
      "severity": {
        "type": "string",
        "description": "심각도 레벨",
        "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW"],
        "default": "MEDIUM"
      },
      
      "checkType": {
        "type": "string",
        "description": "v4.0 검사 방식 - 4가지 타입으로 재구성",
        "enum": [
          "pure_regex",
          "llm_with_regex",
          "llm_contextual",
          "llm_with_ast"
        ]
      },
      
      "checkTypeReason": {
        "type": "string",
        "description": "checkType 선택 이유 (자동 생성 또는 수동 입력)",
        "maxLength": 200,
        "examples": [
          "System.out.println은 정규식만으로 100% 탐지 가능",
          "빈 catch 블록은 정규식으로 후보 탐지 후 LLM으로 의도적 무시 여부 판단 필요"
        ]
      },
      
      "originalCheckType": {
        "type": ["string", "null"],
        "description": "원래 checkType (마이그레이션 추적용). v3.x에서 마이그레이션된 규칙만 해당",
        "enum": ["regex", "ast", "combined", "llm_contextual", "llm_with_ast", null],
        "default": null
      },
      
      "antiPatterns": {
        "type": "array",
        "description": "위반 탐지 정규식 패턴. 이 패턴이 매칭되면 위반 후보",
        "items": {
          "type": "object",
          "properties": {
            "pattern": {
              "type": "string",
              "description": "정규식 패턴"
            },
            "flags": {
              "type": "string",
              "description": "정규식 플래그",
              "default": "g"
            },
            "description": {
              "type": "string",
              "description": "패턴 설명"
            }
          },
          "required": ["pattern"]
        },
        "examples": [
          [
            {
              "pattern": "System\\.out\\.print(ln)?\\s*\\(",
              "flags": "g",
              "description": "System.out.print 또는 println 호출"
            }
          ]
        ]
      },
      
      "goodPatterns": {
        "type": "array",
        "description": "정상 코드 확인 정규식. 이 패턴이 있으면 위반 아님 (예외 처리용)",
        "items": {
          "type": "object",
          "properties": {
            "pattern": {
              "type": "string",
              "description": "정규식 패턴"
            },
            "flags": {
              "type": "string",
              "description": "정규식 플래그",
              "default": "g"
            },
            "description": {
              "type": "string",
              "description": "패턴 설명"
            }
          },
          "required": ["pattern"]
        }
      },
      
      "astDescription": {
        "type": ["string", "null"],
        "description": "AST 검사 기준 자연어 설명 (LLM용). llm_with_ast 필수 필드",
        "minLength": 10,
        "examples": [
          "검사 대상: catch 블록. 해당 블록이 비어있으면 위반입니다. 최소 1개 이상의 statement가 필요합니다."
        ]
      },
      
      "checkPoints": {
        "type": "array",
        "description": "LLM에게 제공할 체크포인트 목록. 순서대로 확인하면 위반 여부 판단 가능",
        "items": {
          "type": "string"
        },
        "examples": [
          [
            "catch 블록이 존재하는가?",
            "catch 블록 내부에 코드가 있는가?",
            "예외를 로깅하거나 처리하는 코드가 있는가?"
          ]
        ]
      },
      
      "astHints": {
        "type": "object",
        "description": "AST 검사 힌트 (레거시 호환용, llm_with_ast에서 astDescription으로 대체)",
        "properties": {
          "nodeTypes": {
            "type": "array",
            "description": "검사 대상 AST 노드 타입",
            "items": { "type": "string" },
            "examples": [["CatchClause", "TryStatement", "MethodDeclaration"]]
          },
          "checkConditions": {
            "type": "array",
            "description": "검사 조건 목록",
            "items": { "type": "string" }
          },
          "checkEmpty": {
            "type": "boolean",
            "description": "빈 블록 검사 여부"
          },
          "maxLineCount": {
            "type": "integer",
            "description": "최대 라인 수"
          },
          "maxCyclomaticComplexity": {
            "type": "integer",
            "description": "최대 순환 복잡도"
          },
          "maxNestingDepth": {
            "type": "integer",
            "description": "최대 중첩 깊이"
          },
          "maxParameters": {
            "type": "integer",
            "description": "최대 파라미터 수"
          },
          "maxBodyStatements": {
            "type": "integer",
            "description": "블록 내 최대 statement 수"
          }
        }
      },
      
      "keywords": {
        "type": "array",
        "description": "규칙 적용 필터링용 키워드. 소스코드에 키워드가 있을 때만 규칙 적용",
        "items": {
          "type": "string"
        },
        "examples": [["catch", "try", "exception"]]
      },
      
      "examples": {
        "type": "object",
        "description": "코드 예시",
        "properties": {
          "bad": {
            "type": "array",
            "description": "나쁜 예시 코드",
            "items": {
              "type": "string"
            }
          },
          "good": {
            "type": "array",
            "description": "좋은 예시 코드",
            "items": {
              "type": "string"
            }
          }
        },
        "examples": [
          {
            "bad": ["try {\n  riskyOperation();\n} catch (Exception e) {\n  // 아무것도 안 함\n}"],
            "good": ["try {\n  riskyOperation();\n} catch (Exception e) {\n  logger.error(\"Error\", e);\n}"]
          }
        ]
      },
      
      "tagCondition": {
        "type": ["object", "string", "null"],
        "description": "태그 기반 필터링 조건. 문자열(표현식) 또는 객체 형태 지원",
        "oneOf": [
          {
            "type": "string",
            "description": "태그 논리식 (&&, ||, !, () 지원)",
            "examples": ["IS_CONTROLLER && HAS_DB_CALL", "HAS_TRY && HAS_CATCH"]
          },
          {
            "type": "object",
            "properties": {
              "expression": {
                "type": "string",
                "description": "태그 논리식 (&&, ||, !, () 지원)",
                "examples": ["IS_CONTROLLER && HAS_DB_CALL", "HAS_TRY && HAS_CATCH"]
              },
              "description": {
                "type": "string",
                "description": "조건 설명"
              }
            },
            "required": ["expression"]
          },
          {
            "type": "null"
          }
        ]
      },
      
      "requiredTags": {
        "type": "array",
        "description": "필수 태그 목록 (모두 충족해야 규칙 적용)",
        "items": { "type": "string" },
        "examples": [["HAS_TRY", "HAS_CATCH"]]
      },
      
      "excludeTags": {
        "type": "array",
        "description": "제외 태그 목록 (하나라도 있으면 규칙 미적용)",
        "items": { "type": "string" },
        "examples": [["IS_TEST_CLASS", "HAS_IGNORE_ANNOTATION"]]
      },
      
      "prerequisite": {
        "type": "object",
        "description": "검사 전제 조건. 이 조건이 만족될 때만 규칙 검사 수행",
        "properties": {
          "expression": {
            "type": "string",
            "description": "전제 조건 태그 논리식"
          },
          "description": {
            "type": "string",
            "description": "전제 조건 설명"
          }
        },
        "required": ["expression"]
      },
      
      "message": {
        "type": "string",
        "description": "위반 시 표시할 메시지",
        "maxLength": 200,
        "examples": ["빈 catch 블록이 발견되었습니다"]
      },
      
      "suggestion": {
        "type": "string",
        "description": "개선 제안",
        "maxLength": 300,
        "examples": ["예외를 로깅하거나 적절히 처리하세요"]
      },
      
      "businessRules": {
        "type": "array",
        "description": "관련 비즈니스 규칙 목록",
        "items": { "type": "string" }
      },
      
      "isActive": {
        "type": "boolean",
        "description": "규칙 활성화 여부",
        "default": true
      },
      
      "metadata": {
        "type": "object",
        "description": "추가 메타데이터",
        "properties": {
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "생성 일시"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time",
            "description": "수정 일시"
          },
          "source": {
            "type": "string",
            "description": "규칙 출처 (가이드라인 문서 섹션 등)",
            "examples": ["개발가이드 2.3.1절"]
          },
          "version": {
            "type": "string",
            "description": "규칙 버전"
          },
          "migratedAt": {
            "type": "string",
            "format": "date-time",
            "description": "마이그레이션 일시 (v3.x → v4.0)"
          }
        }
      }
    },
    
    "allOf": [
      {
        "$comment": "pure_regex: antiPatterns 또는 goodPatterns 중 하나 필수",
        "if": {
          "properties": {
            "checkType": { "const": "pure_regex" }
          },
          "required": ["checkType"]
        },
        "then": {
          "anyOf": [
            { "required": ["antiPatterns"] },
            { "required": ["goodPatterns"] }
          ]
        }
      },
      {
        "$comment": "llm_with_regex: antiPatterns 필수 (정규식으로 후보 탐지 필요)",
        "if": {
          "properties": {
            "checkType": { "const": "llm_with_regex" }
          },
          "required": ["checkType"]
        },
        "then": {
          "required": ["antiPatterns"],
          "properties": {
            "antiPatterns": {
              "minItems": 1
            }
          }
        }
      },
      {
        "$comment": "llm_contextual: keywords 또는 tagCondition 중 하나 필수",
        "if": {
          "properties": {
            "checkType": { "const": "llm_contextual" }
          },
          "required": ["checkType"]
        },
        "then": {
          "anyOf": [
            { 
              "required": ["keywords"],
              "properties": {
                "keywords": { "minItems": 1 }
              }
            },
            { "required": ["tagCondition"] }
          ]
        }
      },
      {
        "$comment": "llm_with_ast: astDescription 필수, checkPoints 권장",
        "if": {
          "properties": {
            "checkType": { "const": "llm_with_ast" }
          },
          "required": ["checkType"]
        },
        "then": {
          "required": ["astDescription"],
          "properties": {
            "astDescription": {
              "minLength": 10
            }
          }
        }
      }
    ],
    
    "additionalProperties": false,
    
    "$defs": {
      "checkTypeDecisionGuide": {
        "description": "checkType 결정 가이드 (참고용)",
        "type": "object",
        "properties": {
          "pure_regex": {
            "description": "정규식만으로 100% 정확한 탐지가 가능한 경우",
            "examples": [
              "System.out.println 사용 금지",
              "e.printStackTrace() 사용 금지",
              "TODO/FIXME 주석 탐지"
            ]
          },
          "llm_with_regex": {
            "description": "정규식으로 후보 탐지 후 LLM으로 문맥 검증이 필요한 경우",
            "examples": [
              "빈 catch 블록 (의도적 무시 vs 실수)",
              "finally 내 close() 호출 (try-with-resources 대체 가능 여부)",
              "synchronized 블록 (필요성 검증)"
            ]
          },
          "llm_contextual": {
            "description": "의미론적/비즈니스 로직 분석이 필요한 경우",
            "examples": [
              "Controller에서 비즈니스 로직 분리",
              "레이어 규칙 위반 (Controller → DAO 직접 호출)",
              "트랜잭션 경계 관리"
            ]
          },
          "llm_with_ast": {
            "description": "코드 구조(AST) 정보가 판단에 핵심인 경우",
            "examples": [
              "메서드 길이 초과",
              "순환 복잡도 초과",
              "중첩 깊이 초과",
              "파라미터 수 초과"
            ]
          }
        }
      }
    }
  }